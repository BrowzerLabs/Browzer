<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Browser Integration Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid;
        }
        .success { background: #d4edda; color: #155724; border-left-color: #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left-color: #dc3545; }
        .info { background: #d1ecf1; color: #0c5460; border-left-color: #17a2b8; }
        .warning { background: #fff3cd; color: #856404; border-left-color: #ffc107; }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.4;
        }
        
        .test-section {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #495057;
        }
        
        .tool-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .tool-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #007bff;
        }
        
        .tool-name {
            font-weight: 600;
            color: #007bff;
        }
        
        .tool-desc {
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ MCP Browser Integration Test</h1>
        
        <div class="info">
            <strong>Testing:</strong> McpClientManager in Browzer's Electron renderer process<br>
            <strong>Goal:</strong> Verify MCP works with browser APIs (fetch, localStorage, WebSocket)
        </div>

        <div class="test-section">
            <h3>üîß Environment Check</h3>
            <button onclick="testEnvironment()">Check Browser APIs</button>
            <div id="env-status"></div>
        </div>

        <div class="test-section">
            <h3>üíæ Storage Test</h3>
            <button onclick="testStorage()">Test localStorage</button>
            <button onclick="clearStorage()">Clear Storage</button>
            <div id="storage-status"></div>
        </div>

        <div class="test-section">
            <h3>üåê MCP Connection Test</h3>
            <button onclick="testMcpConnection()">Test Zapier MCP</button>
            <button onclick="testToolsList()" id="tools-btn" disabled>List Tools</button>
            <button onclick="testToolCall()" id="call-btn" disabled>Test Tool Call</button>
            <div id="mcp-status"></div>
        </div>

        <div class="test-section">
            <h3>üõ†Ô∏è Available Tools</h3>
            <div id="tools-grid" class="tool-grid"></div>
        </div>

        <div class="test-section">
            <h3>üìù Test Log</h3>
            <button onclick="clearLog()">Clear Log</button>
            <div id="log" class="log">Ready to test MCP integration...\n</div>
        </div>
    </div>

    <script type="module">
        let logElement = document.getElementById('log');
        let mcpManager = null;
        let discoveredTools = [];

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `${timestamp} - ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function setStatus(elementId, message, type = 'info') {
            document.getElementById(elementId).innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        window.clearLog = function() {
            logElement.textContent = 'Log cleared...\n';
        }

        window.testEnvironment = function() {
            log('üîç Testing browser environment...');
            
            const tests = [
                { name: 'fetch API', test: () => typeof fetch !== 'undefined' },
                { name: 'WebSocket API', test: () => typeof WebSocket !== 'undefined' },
                { name: 'localStorage', test: () => typeof localStorage !== 'undefined' },
                { name: 'EventSource', test: () => typeof EventSource !== 'undefined' },
                { name: 'URL constructor', test: () => typeof URL !== 'undefined' },
                { name: 'JSON', test: () => typeof JSON !== 'undefined' },
                { name: 'Promise', test: () => typeof Promise !== 'undefined' },
                { name: 'async/await', test: () => {
                    try {
                        eval('(async () => {})');
                        return true;
                    } catch {
                        return false;
                    }
                }}
            ];

            let allPassed = true;
            let results = [];

            tests.forEach(({ name, test }) => {
                const passed = test();
                allPassed = allPassed && passed;
                results.push(`${passed ? '‚úÖ' : '‚ùå'} ${name}`);
                log(`${passed ? '‚úÖ' : '‚ùå'} ${name}: ${passed ? 'Available' : 'Missing'}`);
            });

            if (allPassed) {
                setStatus('env-status', '‚úÖ All browser APIs available! MCP will work.', 'success');
                log('üéâ Environment check passed!');
            } else {
                setStatus('env-status', '‚ùå Some APIs missing. Check console for details.', 'error');
                log('‚ùå Environment check failed!');
            }
        }

        window.testStorage = function() {
            log('üíæ Testing localStorage...');
            
            try {
                // Test basic storage
                const testKey = 'mcp_test';
                const testData = { 
                    servers: [
                        { name: 'test', url: 'https://example.com', enabled: true }
                    ],
                    timestamp: Date.now()
                };
                
                localStorage.setItem(testKey, JSON.stringify(testData));
                const retrieved = JSON.parse(localStorage.getItem(testKey));
                localStorage.removeItem(testKey);
                
                if (retrieved && retrieved.servers && retrieved.servers.length === 1) {
                    setStatus('storage-status', '‚úÖ localStorage working perfectly!', 'success');
                    log('‚úÖ localStorage read/write/delete works');
                } else {
                    throw new Error('Data mismatch');
                }
                
                // Test MCP config storage
                const mcpConfigs = [
                    {
                        name: 'zapier',
                        url: 'https://mcp.zapier.com/api/mcp/s/ZjgwOGM1ZjctYjBkZC00ZWM4LWFiOGEtMGE2ZTA0NmJhNzgzOjdjNDEwOTc0LTIzNTctNGYyYy1hZTBiLWU4Mjg2OTA2MzZlZQ==/mcp',
                        enabled: true,
                        transport: 'sse'
                    }
                ];
                
                localStorage.setItem('mcp_servers', JSON.stringify(mcpConfigs));
                log('‚úÖ MCP server config stored');
                
            } catch (error) {
                setStatus('storage-status', `‚ùå localStorage failed: ${error.message}`, 'error');
                log(`‚ùå localStorage test failed: ${error.message}`);
            }
        }

        window.clearStorage = function() {
            localStorage.removeItem('mcp_servers');
            localStorage.removeItem('mcp_test');
            setStatus('storage-status', 'üßπ Storage cleared', 'info');
            log('üßπ MCP storage cleared');
        }

        window.testMcpConnection = async function() {
            log('üåê Testing MCP connection...');
            setStatus('mcp-status', '‚è≥ Connecting to Zapier MCP server...', 'info');
            
            try {
                // Simulate McpClientManager functionality
                const zapierUrl = 'https://mcp.zapier.com/api/mcp/s/ZjgwOGM1ZjctYjBkZC00ZWM4LWFiOGEtMGE2ZTA0NmJhNzgzOjdjNDEwOTc0LTIzNTctNGYyYy1hZTBiLWU4Mjg2OTA2MzZlZQ==/mcp';
                
                const initPayload = {
                    jsonrpc: '2.0',
                    id: 1,
                    method: 'initialize',
                    params: {
                        protocolVersion: '2024-11-05',
                        capabilities: { tools: {} },
                        clientInfo: {
                            name: 'browzer-assistant-browser-test',
                            version: '1.0.0'
                        }
                    }
                };

                log('üì§ Sending initialize request...');
                
                const response = await fetch(zapierUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json, text/event-stream'
                    },
                    body: JSON.stringify(initPayload)
                });

                log(`üì• Response: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // Handle SSE response
                if (response.headers.get('content-type')?.includes('text/event-stream')) {
                    log('üì° Processing SSE stream...');
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';

                        let currentEvent = {};
                        
                        for (const line of lines) {
                            if (line.startsWith('data:')) {
                                currentEvent.data = line.substring(5).trim();
                            } else if (line === '') {
                                if (currentEvent.data) {
                                    try {
                                        const eventData = JSON.parse(currentEvent.data);
                                        log(`üì• Event: ${currentEvent.data.substring(0, 100)}...`);
                                        
                                        if (eventData.result && eventData.result.serverInfo) {
                                            const server = eventData.result.serverInfo;
                                            log(`‚úÖ Connected to: ${server.name} v${server.version}`);
                                            setStatus('mcp-status', `‚úÖ Connected to ${server.name} v${server.version}`, 'success');
                                            
                                            // Enable tools button
                                            document.getElementById('tools-btn').disabled = false;
                                            return;
                                        }
                                    } catch (parseError) {
                                        log(`‚ö†Ô∏è Parse error: ${parseError.message}`);
                                    }
                                }
                                currentEvent = {};
                            }
                        }
                    }
                }
                
            } catch (error) {
                log(`‚ùå Connection failed: ${error.message}`);
                setStatus('mcp-status', `‚ùå Connection failed: ${error.message}`, 'error');
                
                if (error.message.includes('CORS')) {
                    log('üí° CORS error - server may not allow browser requests');
                } else if (error.message.includes('network')) {
                    log('üí° Network error - check internet connection');
                }
            }
        }

        window.testToolsList = async function() {
            log('üõ†Ô∏è Requesting tools list...');
            
            try {
                const zapierUrl = 'https://mcp.zapier.com/api/mcp/s/ZjgwOGM1ZjctYjBkZC00ZWM4LWFiOGEtMGE2ZTA0NmJhNzgzOjdjNDEwOTc0LTIzNTctNGYyYy1hZTBiLWU4Mjg2OTA2MzZlZQ==/mcp';
                
                const toolsPayload = {
                    jsonrpc: '2.0',
                    id: 2,
                    method: 'tools/list',
                    params: {}
                };

                const response = await fetch(zapierUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json, text/event-stream'
                    },
                    body: JSON.stringify(toolsPayload)
                });

                if (response.headers.get('content-type')?.includes('text/event-stream')) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';

                        let currentEvent = {};
                        
                        for (const line of lines) {
                            if (line.startsWith('data:')) {
                                currentEvent.data = line.substring(5).trim();
                            } else if (line === '') {
                                if (currentEvent.data) {
                                    try {
                                        const eventData = JSON.parse(currentEvent.data);
                                        if (eventData.result && eventData.result.tools) {
                                            const tools = eventData.result.tools;
                                            discoveredTools = tools;
                                            
                                            log(`‚úÖ Found ${tools.length} tools!`);
                                            
                                            // Display tools in grid
                                            const toolsGrid = document.getElementById('tools-grid');
                                            toolsGrid.innerHTML = tools.map(tool => `
                                                <div class="tool-item">
                                                    <div class="tool-name">${tool.name}</div>
                                                    <div class="tool-desc">${tool.description || 'No description'}</div>
                                                </div>
                                            `).join('');
                                            
                                            // Enable tool call button
                                            document.getElementById('call-btn').disabled = false;
                                            
                                            return;
                                        }
                                    } catch (parseError) {
                                        log(`‚ö†Ô∏è Parse error: ${parseError.message}`);
                                    }
                                }
                                currentEvent = {};
                            }
                        }
                    }
                }
                
            } catch (error) {
                log(`‚ùå Tools list failed: ${error.message}`);
            }
        }

        window.testToolCall = async function() {
            if (discoveredTools.length === 0) {
                log('‚ùå No tools available. Run "List Tools" first.');
                return;
            }
            
            // Find a safe tool to test (gmail_find_email is read-only)
            const testTool = discoveredTools.find(t => t.name === 'gmail_find_email') || discoveredTools[0];
            
            log(`üß™ Testing tool call: ${testTool.name}`);
            
            try {
                const zapierUrl = 'https://mcp.zapier.com/api/mcp/s/ZjgwOGM1ZjctYjBkZC00ZWM4LWFiOGEtMGE2ZTA0NmJhNzgzOjdjNDEwOTc0LTIzNTctNGYyYy1hZTBiLWU4Mjg2OTA2MzZlZQ==/mcp';
                
                const callPayload = {
                    jsonrpc: '2.0',
                    id: 3,
                    method: 'tools/call',
                    params: {
                        name: testTool.name,
                        arguments: {
                            instructions: 'Find the latest email in my inbox',
                            query: 'in:inbox'
                        }
                    }
                };

                log('üì§ Calling tool...');
                
                const response = await fetch(zapierUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json, text/event-stream'
                    },
                    body: JSON.stringify(callPayload)
                });

                if (response.headers.get('content-type')?.includes('text/event-stream')) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';

                        let currentEvent = {};
                        
                        for (const line of lines) {
                            if (line.startsWith('data:')) {
                                currentEvent.data = line.substring(5).trim();
                            } else if (line === '') {
                                if (currentEvent.data) {
                                    log(`üì• Tool response: ${currentEvent.data.substring(0, 200)}...`);
                                    
                                    try {
                                        const eventData = JSON.parse(currentEvent.data);
                                        if (eventData.result) {
                                            log(`‚úÖ Tool call successful!`);
                                            return;
                                        } else if (eventData.error) {
                                            log(`‚ö†Ô∏è Tool error: ${eventData.error.message}`);
                                            return;
                                        }
                                    } catch (parseError) {
                                        // Continue processing
                                    }
                                }
                                currentEvent = {};
                            }
                        }
                    }
                }
                
            } catch (error) {
                log(`‚ùå Tool call failed: ${error.message}`);
            }
        }

        // Auto-run environment check on load
        window.addEventListener('load', () => {
            log('üöÄ MCP Browser Test loaded');
            log('üí° Click "Check Browser APIs" to start testing');
        });
    </script>
</body>
</html>
