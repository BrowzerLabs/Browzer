name: Build macOS Releases

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      arch:
        description: 'Architecture to build'
        required: true
        default: 'universal'
        type: choice
        options:
          - x64
          - arm64
          - universal

jobs:
  build:
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - arch: x64
            name: Intel
          - arch: arm64
            name: Apple Silicon
          - arch: universal
            name: Universal
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build for macOS (${{ matrix.name }})
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_IDENTITY: ${{ secrets.APPLE_IDENTITY }}
          NODE_ENV: production
          DEBUG: electron-forge:*
        run: |
          if [ "${{ matrix.arch }}" = "x64" ]; then
            npm run make:dmg
          elif [ "${{ matrix.arch }}" = "arm64" ]; then
            npm run make:arm64
          else
            npm run make:universal
          fi
      
      - name: Generate checksums
        run: |
          cd out/make
          for file in *.dmg *.zip; do
            if [ -f "$file" ]; then
              echo "Generating SHA256 for $file"
              shasum -a 256 "$file" > "$file.sha256"
              echo "Generating SHA512 for $file"
              shasum -a 512 "$file" > "$file.sha512"
            fi
          done
          ls -lah
      
      - name: Verify code signing
        run: |
          cd out/make
          for app in *.app; do
            if [ -d "$app" ]; then
              echo "Verifying signature for $app"
              codesign -v -v "$app" || echo "Warning: Could not verify $app"
            fi
          done
      
      - name: Create release notes
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "# Release $VERSION" > release_notes.md
          echo "" >> release_notes.md
          echo "## Downloads" >> release_notes.md
          echo "" >> release_notes.md
          echo "### macOS" >> release_notes.md
          echo "- **Universal Binary** (Intel & Apple Silicon): \`Browzer-${VERSION}.dmg\`" >> release_notes.md
          echo "- **Intel Only**: \`Browzer-${VERSION}-x64.dmg\`" >> release_notes.md
          echo "- **Apple Silicon Only**: \`Browzer-${VERSION}-arm64.dmg\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Verification" >> release_notes.md
          echo "Verify the integrity of downloaded files:" >> release_notes.md
          echo "\`\`\`bash" >> release_notes.md
          echo "shasum -a 256 -c Browzer-${VERSION}.dmg.sha256" >> release_notes.md
          echo "\`\`\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Installation" >> release_notes.md
          echo "1. Download the appropriate DMG for your Mac" >> release_notes.md
          echo "2. Double-click to mount the DMG" >> release_notes.md
          echo "3. Drag Browzer to the Applications folder" >> release_notes.md
          echo "4. Launch from Applications" >> release_notes.md
          cat release_notes.md
      
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            out/make/*.dmg
            out/make/*.zip
            out/make/*.sha256
            out/make/*.sha512
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifacts
        if: '!startsWith(github.ref, ''refs/tags/'')'
        uses: actions/upload-artifact@v3
        with:
          name: browzer-macos-${{ matrix.arch }}
          path: |
            out/make/*.dmg
            out/make/*.zip
            out/make/*.sha256
            out/make/*.sha512
          retention-days: 30

  create-latest-yml:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v3
      
      - name: Create latest-mac.yml
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          
          # Find the DMG file
          DMG_FILE=$(find . -name "*.dmg" -type f | head -1)
          
          if [ -z "$DMG_FILE" ]; then
            echo "Error: No DMG file found"
            exit 1
          fi
          
          # Get file size and SHA512
          SIZE=$(stat -f%z "$DMG_FILE" 2>/dev/null || stat -c%s "$DMG_FILE")
          SHA512=$(shasum -a 512 "$DMG_FILE" | awk '{print $1}')
          
          # Create latest-mac.yml
          cat > latest-mac.yml <<EOF
          version: ${VERSION#v}
          files:
            - url: $(basename "$DMG_FILE")
              sha512: $SHA512
              size: $SIZE
          path: https://github.com/${{ github.repository }}/releases/download/${VERSION}/$(basename "$DMG_FILE")
          sha512: $SHA512
          releaseDate: '$(date -u +'%Y-%m-%dT%H:%M:%S.000Z')'
          EOF
          
          cat latest-mac.yml
      
      - name: Upload latest-mac.yml
        uses: softprops/action-gh-release@v1
        with:
          files: latest-mac.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check build status
        run: |
          if [ "${{ needs.build.result }}" = "success" ]; then
            echo "✅ macOS build completed successfully"
          else
            echo "❌ macOS build failed"
            exit 1
          fi
