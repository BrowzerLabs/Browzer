<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Integration Test</title>
    <style>
        body { font-family: system-ui; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { color: green; }
        .error { color: red; }
        button { margin: 5px; padding: 8px 16px; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow: auto; }
        .log { font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <h1>MCP Integration Test</h1>
    
    <div class="test-section">
        <h3>1. MCP Client Manager Test</h3>
        <button onclick="testMcpManager()">Test MCP Manager</button>
        <div id="manager-result"></div>
    </div>

    <div class="test-section">
        <h3>2. Settings Panel Test</h3>
        <p>Add a test server: <code>ws://localhost:7900/ws</code></p>
        <button onclick="addTestServer()">Add Test Server</button>
        <button onclick="listServers()">List Servers</button>
        <div id="settings-result"></div>
    </div>

    <div class="test-section">
        <h3>3. Router Test</h3>
        <input type="text" id="query-input" placeholder="Enter a query like 'read file /path/to/file'" style="width: 300px;">
        <button onclick="testRouter()">Test Router</button>
        <div id="router-result"></div>
    </div>

    <div class="test-section">
        <h3>4. Tool Call Test</h3>
        <button onclick="testToolCall()">Test read_file tool</button>
        <div id="tool-result"></div>
    </div>

    <div class="test-section">
        <h3>Test Logs</h3>
        <pre id="logs"></pre>
    </div>

    <script>
        // Simple logging
        function log(message) {
            const logs = document.getElementById('logs');
            logs.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }

        // Import our MCP services (this would normally be bundled)
        // For testing, we'll inline simple versions

        class SimpleMcpManager {
            constructor() {
                this.servers = new Map();
                this.toolIndex = new Map();
            }

            loadConfigs() {
                try {
                    const raw = localStorage.getItem('mcp_servers');
                    if (!raw) return [];
                    return JSON.parse(raw);
                } catch {
                    return [];
                }
            }

            saveConfigs(configs) {
                localStorage.setItem('mcp_servers', JSON.stringify(configs));
            }

            addConfig(config) {
                const configs = this.loadConfigs();
                configs.push(config);
                this.saveConfigs(configs);
                log(`Added server: ${config.name}`);
            }

            async listAllTools() {
                return [...this.toolIndex.keys()];
            }
        }

        const mcpManager = new SimpleMcpManager();

        function testMcpManager() {
            const result = document.getElementById('manager-result');
            try {
                const configs = mcpManager.loadConfigs();
                result.innerHTML = `<div class="success">‚úÖ Manager working. Found ${configs.length} servers.</div>`;
                log('MCP Manager test passed');
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
                log(`MCP Manager test failed: ${error.message}`);
            }
        }

        function addTestServer() {
            const result = document.getElementById('settings-result');
            try {
                mcpManager.addConfig({
                    name: 'test-filesystem',
                    url: 'ws://localhost:7900/ws',
                    enabled: true
                });
                result.innerHTML = '<div class="success">‚úÖ Test server added</div>';
                log('Test server added successfully');
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
                log(`Add server failed: ${error.message}`);
            }
        }

        function listServers() {
            const result = document.getElementById('settings-result');
            const configs = mcpManager.loadConfigs();
            const serverList = configs.map(c => 
                `<li><strong>${c.name}</strong>: ${c.url} (${c.enabled ? 'enabled' : 'disabled'})</li>`
            ).join('');
            result.innerHTML = `<ul>${serverList}</ul>`;
            log(`Listed ${configs.length} servers`);
        }

        function testRouter() {
            const query = document.getElementById('query-input').value;
            const result = document.getElementById('router-result');
            
            if (!query) {
                result.innerHTML = '<div class="error">‚ùå Please enter a query</div>';
                return;
            }

            // Simple router simulation
            const tools = [];
            const q = query.toLowerCase();
            
            if (q.includes('read') || q.includes('file')) {
                tools.push({ toolName: 'filesystem.read_file', score: 3 });
            }
            if (q.includes('list') || q.includes('directory')) {
                tools.push({ toolName: 'filesystem.list_dir', score: 2 });
            }
            
            result.innerHTML = `
                <div class="success">‚úÖ Router found ${tools.length} relevant tools:</div>
                <ul>${tools.map(t => `<li>${t.toolName} (score: ${t.score})</li>`).join('')}</ul>
            `;
            log(`Router test: "${query}" -> ${tools.length} tools`);
        }

        async function testToolCall() {
            const result = document.getElementById('tool-result');
            result.innerHTML = '<div>üîÑ Testing WebSocket connection...</div>';
            
            try {
                // Test WebSocket connection to our test server
                const ws = new WebSocket('ws://localhost:7900/ws');
                
                ws.onopen = () => {
                    log('WebSocket connected to test server');
                    
                    // Send listTools request
                    ws.send(JSON.stringify({
                        jsonrpc: '2.0',
                        id: '1',
                        method: 'listTools'
                    }));
                };
                
                ws.onmessage = (event) => {
                    const response = JSON.parse(event.data);
                    log(`Received: ${JSON.stringify(response)}`);
                    
                    if (response.result) {
                        const tools = response.result;
                        result.innerHTML = `
                            <div class="success">‚úÖ Connected to test server!</div>
                            <div>Available tools: ${tools.map(t => t.name).join(', ')}</div>
                        `;
                    }
                    
                    ws.close();
                };
                
                ws.onerror = (error) => {
                    result.innerHTML = `
                        <div class="error">‚ùå WebSocket connection failed</div>
                        <div class="log">Make sure to run: node test-mcp-server.js</div>
                    `;
                    log('WebSocket connection failed');
                };
                
            } catch (error) {
                result.innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
                log(`Tool call test failed: ${error.message}`);
            }
        }

        // Initialize
        log('MCP Integration Test page loaded');
        log('To test fully, run: node test-mcp-server.js');
    </script>
</body>
</html>
