<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browzer Settings</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="chrome-settings-container">
        <!-- Sidebar Navigation -->
        <aside class="settings-sidebar">
            <div class="settings-sidebar-header">
                <h1 class="settings-sidebar-title">
                    <span class="settings-icon">‚öôÔ∏è</span>
                    Settings
                </h1>
                <p class="settings-sidebar-subtitle">Customize your Browzer experience</p>
            </div>
            
            <nav class="settings-nav">
                <div class="settings-nav-item">
                    <a href="#ai-keys" class="settings-nav-link active" data-section="ai-keys">
                        <span class="settings-nav-icon">üîë</span>
                        AI Integration
                    </a>
                </div>
                <div class="settings-nav-item">
                    <a href="#interface" class="settings-nav-link" data-section="interface">
                        <span class="settings-nav-icon">üé®</span>
                        Interface
                    </a>
                </div>
                <div class="settings-nav-item">
                    <a href="#privacy" class="settings-nav-link" data-section="privacy">
                        <span class="settings-nav-icon">üõ°Ô∏è</span>
                        Privacy & Security
                    </a>
                </div>
                <div class="settings-nav-item">
                    <a href="#ai-memory" class="settings-nav-link" data-section="ai-memory">
                        <span class="settings-nav-icon">üß†</span>
                        AI Memory
                    </a>
                </div>
                <div class="settings-nav-item">
                    <a href="#cache" class="settings-nav-link" data-section="cache">
                        <span class="settings-nav-icon">üíæ</span>
                        Cache & Storage
                    </a>
                </div>
                <div class="settings-nav-item">
                    <a href="#mcp-servers" class="settings-nav-link" data-section="mcp-servers">
                        <span class="settings-nav-icon">üîå</span>
                        MCP Servers
                    </a>
                </div>
                <div class="settings-nav-item">
                    <a href="#general" class="settings-nav-link" data-section="general">
                        <span class="settings-nav-icon">üîß</span>
                        General
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="settings-main">
            <!-- AI Integration Section -->
            <section id="ai-keys" class="settings-section">
                <div class="settings-main-header">
                    <h1 class="settings-main-title">AI Integration</h1>
                    <p class="settings-main-subtitle">Configure your AI providers and API keys for enhanced browsing assistance</p>
                </div>

                <div class="settings-card">
                    <div class="settings-card-header">
                        <h3 class="settings-card-title">
                            <span class="settings-icon">üîë</span>
                            API Keys
                        </h3>
                        <p class="settings-card-description">Add your API keys to enable AI-powered features</p>
                    </div>
                    <div class="settings-card-content">
                        <!-- OpenAI API Key input commented out -->
                        <!-- <div class="chrome-form-group">
                            <label class="chrome-form-label" for="openaiApiKey">OpenAI API Key</label>
                            <div class="chrome-input-with-button">
                                <input type="password" id="openaiApiKey" class="chrome-form-input" placeholder="sk-...">
                                <button class="chrome-btn chrome-btn-primary chrome-btn-small" id="saveOpenaiBtn">Save</button>
                            </div>
                            <p class="chrome-form-description">Used for GPT models and chat assistance</p>
                        </div> -->
                        
                        <div class="chrome-form-group">
                            <label class="chrome-form-label" for="anthropicApiKey">Anthropic API Key</label>
                            <div class="chrome-input-with-button">
                                <input type="password" id="anthropicApiKey" class="chrome-form-input" placeholder="sk-ant-...">
                                <button class="chrome-btn chrome-btn-primary chrome-btn-small" id="saveAnthropicBtn">Save</button>
                            </div>
                            <p class="chrome-form-description">Used for Claude models</p>
                        </div>
                        
                        <!-- Perplexity API Key input commented out -->
                        <!-- <div class="chrome-form-group">
                            <label class="chrome-form-label" for="perplexityApiKey">Perplexity API Key</label>
                            <div class="chrome-input-with-button">
                                <input type="password" id="perplexityApiKey" class="chrome-form-input" placeholder="pplx-...">
                                <button class="chrome-btn chrome-btn-primary chrome-btn-small" id="savePerplexityBtn">Save</button>
                            </div>
                            <p class="chrome-form-description">Used for web search and research</p>
                        </div> -->
                        
                        <!-- Chutes API Key input commented out -->
                        <!-- <div class="chrome-form-group">
                            <label class="chrome-form-label" for="chutesApiKey">Chutes API Key</label>
                            <div class="chrome-input-with-button">
                                <input type="password" id="chutesApiKey" class="chrome-form-input" placeholder="ch-...">
                                <button class="chrome-btn chrome-btn-primary chrome-btn-small" id="saveChutesBtn">Save</button>
                            </div>
                            <p class="chrome-form-description">Used for specialized AI services</p>
                        </div> -->
                    </div>
                </div>
            </section>

            <!-- Interface Section -->
            <section id="interface" class="settings-section hidden">
                <div class="settings-main-header">
                    <h1 class="settings-main-title">Interface</h1>
                    <p class="settings-main-subtitle">Customize the look and feel of your browser</p>
                </div>

                <div class="settings-card">
                    <div class="settings-card-header">
                        <h3 class="settings-card-title">
                            <span class="settings-icon">üé®</span>
                            Layout Options
                        </h3>
                        <p class="settings-card-description">Choose how you want your tabs and interface to be organized</p>
                    </div>
                    <div class="settings-card-content">
                        <div class="chrome-toggle-row">
                            <div class="chrome-toggle-content">
                                <div class="chrome-toggle-title">Sidebar Tab Layout</div>
                                <div class="chrome-toggle-description">Display tabs vertically in a sidebar instead of horizontally</div>
                            </div>
                            <div class="chrome-toggle-switch" id="sidebarToggle">
                                <input type="checkbox" id="sidebarEnabled" class="chrome-toggle-input">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-card-header">
                        <h3 class="settings-card-title">
                            <span class="settings-icon">üè†</span>
                            Homepage
                        </h3>
                        <p class="settings-card-description">Set your default homepage</p>
                    </div>
                    <div class="settings-card-content">
                        <div class="chrome-form-group">
                            <label class="chrome-form-label" for="homepageInput">Homepage URL</label>
                            <input type="url" id="homepageInput" class="chrome-form-input" placeholder="https://www.google.com">
                            <p class="chrome-form-description">This page will open when you create a new tab</p>
                        </div>
                        <div class="chrome-button-group">
                            <button class="chrome-btn chrome-btn-primary" id="saveHomepageBtn">Save Homepage</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Privacy & Security Section -->
            <section id="privacy" class="settings-section hidden">
                <div class="settings-main-header">
                    <h1 class="settings-main-title">Privacy & Security</h1>
                    <p class="settings-main-subtitle">Control your privacy settings and ad blocking preferences</p>
                </div>

                <div class="settings-card">
                    <div class="settings-card-header">
                        <h3 class="settings-card-title">
                            <span class="settings-icon">üõ°Ô∏è</span>
                            Ad Blocker
                        </h3>
                        <p class="settings-card-description">Block unwanted ads and trackers for a cleaner browsing experience</p>
                    </div>
                    <div class="settings-card-content">
                        <div class="chrome-toggle-row">
                            <div class="chrome-toggle-content">
                                <div class="chrome-toggle-title">Enable Ad Blocker</div>
                                <div class="chrome-toggle-description">Block ads, trackers, and malicious content</div>
                            </div>
                            <div class="chrome-toggle-switch" id="adBlockToggle">
                                <input type="checkbox" id="adBlockEnabled" class="chrome-toggle-input" checked>
                            </div>
                        </div>

                        <div class="chrome-stats-grid">
                            <div class="chrome-stat-card">
                                <span class="chrome-stat-value" id="blockedDomainsCount">0</span>
                                <p class="chrome-stat-label">Blocked Domains</p>
                            </div>
                            <div class="chrome-stat-card">
                                <span class="chrome-stat-value" id="cssRulesCount">0</span>
                                <p class="chrome-stat-label">CSS Rules</p>
                            </div>
                            <div class="chrome-stat-card">
                                <span class="chrome-stat-value" id="filterRulesCount">0</span>
                                <p class="chrome-stat-label">Filter Rules</p>
                            </div>
                        </div>

                        <div class="chrome-domain-management">
                            <div class="chrome-domain-section">
                                <h4 class="chrome-domain-section-title">Blocked Domains</h4>
                                <div class="chrome-domain-input-group">
                                    <input type="text" id="blockedDomainInput" class="chrome-domain-input" placeholder="example.com">
                                    <button class="chrome-btn chrome-btn-secondary" id="addBlockedDomainBtn">Block</button>
                                </div>
                                <div class="chrome-domain-list" id="blockedDomainsList"></div>
                            </div>
                            
                            <div class="chrome-domain-section">
                                <h4 class="chrome-domain-section-title">Allowed Domains</h4>
                                <div class="chrome-domain-input-group">
                                    <input type="text" id="allowedDomainInput" class="chrome-domain-input" placeholder="trusted-site.com">
                                    <button class="chrome-btn chrome-btn-secondary" id="addAllowedDomainBtn">Allow</button>
                                </div>
                                <div class="chrome-domain-list" id="allowedDomainsList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- AI Memory Section -->
            <section id="ai-memory" class="settings-section hidden">
                <div class="settings-main-header">
                    <h1 class="settings-main-title">AI Memory</h1>
                    <p class="settings-main-subtitle">Manage your AI assistant's memory and conversation history</p>
                </div>

                <div class="settings-card">
                    <div class="settings-card-header">
                        <h3 class="settings-card-title">
                            <span class="settings-icon">üß†</span>
                            Memory Management
                        </h3>
                        <p class="settings-card-description">Control how your AI assistant remembers past interactions</p>
                    </div>
                    <div class="settings-card-content">
                        <div class="chrome-stats-grid">
                            <div class="chrome-stat-card">
                                <span class="chrome-stat-value" id="memoryCount">0</span>
                                <p class="chrome-stat-label">Stored Memories</p>
                            </div>
                        </div>

                        <div class="chrome-button-group">
                            <button class="chrome-btn chrome-btn-secondary" id="exportMemoryBtn">Export Memory</button>
                            <input type="file" id="importMemoryInput" accept=".json" style="display: none;">
                            <button class="chrome-btn chrome-btn-secondary" id="importMemoryBtn">Import Memory</button>
                            <button class="chrome-btn chrome-btn-danger" id="clearMemoryBtn">Clear All Memory</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Cache & Storage Section -->
            <section id="cache" class="settings-section hidden">
                <div class="settings-main-header">
                    <h1 class="settings-main-title">Cache & Storage</h1>
                    <p class="settings-main-subtitle">Configure how Browzer stores and manages cached content</p>
                </div>

                <div class="settings-card">
                    <div class="settings-card-header">
                        <h3 class="settings-card-title">
                            <span class="settings-icon">üíæ</span>
                            Cache Settings
                        </h3>
                        <p class="settings-card-description">Manage browser cache size and cleanup options</p>
                    </div>
                    <div class="settings-card-content">
                        <div class="chrome-form-group">
                            <label class="chrome-form-label" for="maxCacheSize">Maximum Cache Size (MB)</label>
                            <input type="number" id="maxCacheSize" class="chrome-form-input" value="50" min="10" max="1000">
                            <p class="chrome-form-description">Maximum amount of disk space to use for caching</p>
                        </div>

                        <div class="chrome-toggle-row">
                            <div class="chrome-toggle-content">
                                <div class="chrome-toggle-title">Auto Cleanup</div>
                                <div class="chrome-toggle-description">Automatically clean up old cache files when limit is reached</div>
                            </div>
                            <div class="chrome-toggle-switch" id="autoCleanupToggle">
                                <input type="checkbox" id="autoCleanupEnabled" class="chrome-toggle-input" checked>
                            </div>
                        </div>

                        <div class="chrome-stats-grid">
                            <div class="chrome-stat-card">
                                <span class="chrome-stat-value" id="totalCacheSize">0 MB</span>
                                <p class="chrome-stat-label">Current Size</p>
                            </div>
                            <div class="chrome-stat-card">
                                <span class="chrome-stat-value" id="cacheItemCount">0</span>
                                <p class="chrome-stat-label">Cached Items</p>
                            </div>
                        </div>

                        <div class="chrome-button-group">
                            <button class="chrome-btn chrome-btn-primary" id="saveCacheSettingsBtn">Save Settings</button>
                            <button class="chrome-btn chrome-btn-danger" id="clearCacheBtn">Clear Cache</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- MCP Servers Section -->
            <section id="mcp-servers" class="settings-section hidden">
                <div class="settings-main-header">
                    <h1 class="settings-main-title">MCP Servers</h1>
                    <p class="settings-main-subtitle">Connect to Model Context Protocol servers for enhanced AI capabilities</p>
                </div>

                <div class="settings-card">
                    <div id="mcp-servers-root" class="settings-card-content">
                        <!-- McpServersPanel will be rendered here -->
                    </div>
                </div>
                
                <!-- MCP Testing Section -->
                <div class="settings-card" style="margin-top: 20px;">
                    <div class="settings-card-header">
                        <h3 class="settings-card-title">üß™ MCP Integration Testing</h3>
                        <p class="settings-card-subtitle">Test MCP functionality directly in Browzer</p>
                    </div>
                    <div class="settings-card-content">
                        <button onclick="testMcpIntegration()" class="chrome-btn chrome-btn-primary" style="margin-right: 10px;">
                            üöÄ Run MCP Test
                        </button>
                        <button onclick="clearMcpTestLog()" class="chrome-btn chrome-btn-secondary">
                            üßπ Clear Log
                        </button>
                        <div id="mcp-test-log" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin-top: 15px; font-family: 'SF Mono', Monaco, monospace; font-size: 12px; white-space: pre-wrap; max-height: 400px; overflow-y: auto; line-height: 1.4; display: none;"></div>
                        <div id="mcp-test-status" style="margin-top: 10px;"></div>
                    </div>
                </div>
            </section>

            <!-- General Section -->
            <section id="general" class="settings-section hidden">
                <div class="settings-main-header">
                    <h1 class="settings-main-title">General</h1>
                    <p class="settings-main-subtitle">General browser settings and preferences</p>
                </div>

                <div class="settings-card">
                    <div class="settings-card-header">
                        <h3 class="settings-card-title">
                            <span class="settings-icon">‚ÑπÔ∏è</span>
                            About Browzer
                        </h3>
                        <p class="settings-card-description">Version information and updates</p>
                    </div>
                    <div class="settings-card-content">
                        <p>Browzer - AI-Powered Browser</p>
                        <p>Version 1.0.0</p>
                        <p>Built with Electron and modern web technologies</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Toast notifications will be dynamically added here -->

    <script>
        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `settings-toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }
        
        // Communication functions will be injected by the main renderer
        window.sendToMainRenderer = window.sendToBrowser || function(action, data) {
            console.warn('Settings communication not ready yet');
        };

        // Navigation functionality
        function showSection(sectionId) {
            console.log('Showing section:', sectionId);
            
            // Hide all sections
            document.querySelectorAll('.settings-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.settings-nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                console.log('Successfully showed section:', sectionId);
            } else {
                console.warn('Section not found:', sectionId);
            }
            
            // Add active class to clicked nav link
            const activeLink = document.querySelector(`[data-section="${sectionId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
                console.log('Set active nav link for section:', sectionId);
            }
            
            // Update the URL hash without reloading the page
            if (window.location.hash !== '#' + sectionId) {
                window.history.replaceState(null, null, '#' + sectionId);
                console.log('Updated URL hash to:', '#' + sectionId);
            }
        }

        // Toggle switch functionality
        function initializeToggleSwitches() {
            const toggleSwitches = document.querySelectorAll('.chrome-toggle-switch');
            
            toggleSwitches.forEach(toggle => {
                const checkbox = toggle.querySelector('.chrome-toggle-input');
                
                // Set initial state
                if (checkbox && checkbox.checked) {
                    toggle.classList.add('active');
                }
                
                // Add click handler
                toggle.addEventListener('click', () => {
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                        toggle.classList.toggle('active', checkbox.checked);
                        
                        // Trigger change event for specific settings
                        if (checkbox.id === 'sidebarEnabled') {
                            window.sendToMainRenderer('toggle-sidebar', { enabled: checkbox.checked });
                        } else if (checkbox.id === 'adBlockEnabled') {
                            window.sendToMainRenderer('toggle-adblock', { enabled: checkbox.checked });
                        } else if (checkbox.id === 'autoCleanupEnabled') {
                            window.sendToMainRenderer('save-cache-settings', { 
                                maxCacheSize: document.getElementById('maxCacheSize').value,
                                autoCleanupEnabled: checkbox.checked 
                            });
                        }
                    }
                });
            });
        }

        // Initialize MCP Servers Panel
        function initializeMcpPanel() {
            console.log('üîß Initializing MCP Panel...');
            const root = document.getElementById('mcp-servers-root');
            if (!root) {
                console.error('‚ùå MCP root element not found!');
                return;
            }
            console.log('‚úÖ MCP root element found:', root);

            // Inline MCP client manager and panel (keeping it simple for now)
            const STORAGE_KEY = 'mcp_servers';
            
            function loadConfigs() {
                try {
                    const raw = localStorage.getItem(STORAGE_KEY);
                    if (!raw) return [];
                    const list = JSON.parse(raw);
                    return Array.isArray(list) ? list : [];
                } catch {
                    return [];
                }
            }

            function saveConfigs(cfgs) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(cfgs));
            }

            function renderPanel() {
                const cfgs = loadConfigs();
                root.innerHTML = `
                    <h3 class="settings-card-title">
                        <span class="settings-icon">üîå</span> MCP Servers
                    </h3>
                    <p class="settings-card-description">Connect Browzer to external tool servers (Model Context Protocol)</p>
                    <div class="mcp-server-list">
                        ${cfgs.map((c, i) => `
                            <div class="mcp-row">
                                <span class="mcp-name">${c.name}</span>
                                <span class="mcp-url">${c.url}</span>
                                <label class="mcp-toggle">
                                    <input type="checkbox" data-index="${i}" ${c.enabled ? 'checked' : ''}>
                                    <span>Enabled</span>
                                </label>
                                <button class="chrome-btn chrome-btn-danger chrome-btn-small mcp-remove" data-index="${i}">Remove</button>
                            </div>
                        `).join('')}
                    </div>
                    <button id="mcp-add-btn" class="chrome-btn chrome-btn-primary" onclick="window.mcpAddServer && window.mcpAddServer()">Add Server</button>
                `;

                // Add event listeners with error handling
                const addBtn = root.querySelector('#mcp-add-btn');
                console.log('üîò Add button found:', addBtn);
                
                if (addBtn) {
                    // Remove any existing listeners first
                    addBtn.replaceWith(addBtn.cloneNode(true));
                    const newAddBtn = root.querySelector('#mcp-add-btn');
                    
                    newAddBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        console.log('üöÄ Add server button clicked!');
                        showAddServerModal();
                    });
                    
                    console.log('‚úÖ Event listener attached successfully');
                } else {
                    console.error('‚ùå Add button not found in DOM!');
                }

                root.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        const list = loadConfigs();
                        list[index].enabled = e.target.checked;
                        saveConfigs(list);
                    });
                });

                root.querySelectorAll('.mcp-remove').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        const list = loadConfigs();
                        list.splice(index, 1);
                        saveConfigs(list);
                        renderPanel();
                    });
                });
            }

            console.log('üé® Rendering MCP panel...');
            try {
                renderPanel();
                console.log('‚úÖ MCP panel initialized successfully');
            } catch (error) {
                console.error('‚ùå Error rendering MCP panel:', error);
                // Fallback: create a simple working button
                root.innerHTML = `
                    <h3>üîå MCP Servers</h3>
                    <p>Connect to Model Context Protocol servers</p>
                    <button onclick="showAddServerModal()" class="chrome-btn chrome-btn-primary">Add Server (Fallback)</button>
                    <div style="color: red; margin-top: 10px;">Error in main panel. Using fallback method.</div>
                `;
            }
        }

        // Load settings on page load
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            initializeToggleSwitches();
            
            // Initialize MCP panel with retry
            setTimeout(() => {
                console.log('üîÑ Attempting to initialize MCP panel...');
                initializeMcpPanel();
            }, 100);
            
            // Check for anchor in URL and navigate to that section
            const hash = window.location.hash.substring(1); // Remove the #
            if (hash) {
                console.log('Settings page loaded with anchor:', hash);
                showSection(hash);
            } else {
                console.log('Settings page loaded, waiting for data injection...');
            }
        });

        // Listen for hash changes (browser back/forward)
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.substring(1);
            if (hash) {
                console.log('Hash changed to:', hash);
                showSection(hash);
            }
        });

        function setupEventListeners() {
            // Navigation links
            document.querySelectorAll('.settings-nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = link.getAttribute('data-section');
                    showSection(sectionId);
                });
            });

            // API Key save buttons - only Anthropic enabled
            const apiKeyProviders = ['anthropic']; // ['openai', 'anthropic', 'perplexity', 'chutes'];
            apiKeyProviders.forEach(provider => {
                const saveBtn = document.getElementById(`save${provider.charAt(0).toUpperCase() + provider.slice(1)}Btn`);
                const input = document.getElementById(`${provider}ApiKey`);
                
                if (saveBtn && input) {
                    saveBtn.addEventListener('click', () => {
                        const apiKey = input.value.trim();
                        if (apiKey) {
                            // Show saving state
                            const originalText = saveBtn.textContent;
                            saveBtn.textContent = 'Saving...';
                            saveBtn.disabled = true;
                            
                            // Save the API key
                            window.sendToMainRenderer('save-api-key', { provider, apiKey });
                            
                            // Show success feedback
                            setTimeout(() => {
                                saveBtn.textContent = 'Saved!';
                                saveBtn.style.background = '#34a853';
                                
                                // Reset button after 2 seconds
                                setTimeout(() => {
                                    saveBtn.textContent = originalText;
                                    saveBtn.disabled = false;
                                    saveBtn.style.background = '';
                                }, 2000);
                            }, 500);
                        } else {
                            // Show error if no API key entered
                            input.style.borderColor = '#ea4335';
                            input.focus();
                            
                            setTimeout(() => {
                                input.style.borderColor = '';
                            }, 3000);
                        }
                    });
                    
                    // Clear error styling when user starts typing
                    input.addEventListener('input', () => {
                        input.style.borderColor = '';
                    });
                }
            });

            // Memory management buttons
            const clearMemoryBtn = document.getElementById('clearMemoryBtn');
            if (clearMemoryBtn) {
                clearMemoryBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to clear all AI memory? This cannot be undone.')) {
                        window.sendToMainRenderer('clear-memory');
                    }
                });
            }

            // Homepage settings
            const saveHomepageBtn = document.getElementById('saveHomepageBtn');
            if (saveHomepageBtn) {
                saveHomepageBtn.addEventListener('click', () => {
                    const homepageInput = document.getElementById('homepageInput');
                    const homepage = homepageInput?.value.trim();
                    if (homepage) {
                        window.sendToMainRenderer('save-homepage', { homepage });
                    }
                });
            }

            // Cache settings
            const saveCacheSettingsBtn = document.getElementById('saveCacheSettingsBtn');
            if (saveCacheSettingsBtn) {
                saveCacheSettingsBtn.addEventListener('click', () => {
                    const maxCacheSizeInput = document.getElementById('maxCacheSize');
                    const autoCleanupCheckbox = document.getElementById('autoCleanupEnabled');
                    const maxCacheSize = maxCacheSizeInput?.value;
                    const autoCleanupEnabled = autoCleanupCheckbox?.checked;
                    if (maxCacheSize) {
                        window.sendToMainRenderer('save-cache-settings', { maxCacheSize, autoCleanupEnabled });
                    }
                });
            }

            // Domain management
            const addBlockedDomainBtn = document.getElementById('addBlockedDomainBtn');
            if (addBlockedDomainBtn) {
                addBlockedDomainBtn.addEventListener('click', () => {
                    const input = document.getElementById('blockedDomainInput');
                    const domain = input?.value.trim();
                    if (domain) {
                        window.sendToMainRenderer('add-blocked-domain', { domain });
                        input.value = '';
                    }
                });
            }

            const addAllowedDomainBtn = document.getElementById('addAllowedDomainBtn');
            if (addAllowedDomainBtn) {
                addAllowedDomainBtn.addEventListener('click', () => {
                    const input = document.getElementById('allowedDomainInput');
                    const domain = input?.value.trim();
                    if (domain) {
                        window.sendToMainRenderer('add-allowed-domain', { domain });
                        input.value = '';
                    }
                });
            }

            // Export/Import memory
            const exportMemoryBtn = document.getElementById('exportMemoryBtn');
            if (exportMemoryBtn) {
                exportMemoryBtn.addEventListener('click', () => {
                    window.sendToMainRenderer('export-memory');
                });
            }

            const importMemoryBtn = document.getElementById('importMemoryBtn');
            const importMemoryInput = document.getElementById('importMemoryInput');
            if (importMemoryBtn && importMemoryInput) {
                importMemoryBtn.addEventListener('click', () => {
                    importMemoryInput.click();
                });

                importMemoryInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const memories = JSON.parse(e.target.result);
                                window.sendToMainRenderer('import-memory', { memories });
                                showToast('Memory imported successfully', 'success');
                            } catch (error) {
                                showToast('Error importing memory file', 'error');
                            }
                        };
                        reader.readAsText(file);
                    }
                });
            }
        }

        // Stats update functions
        function updateMemoryCount(count) {
            const memoryCountElement = document.getElementById('memoryCount');
            if (memoryCountElement) {
                memoryCountElement.textContent = count || 0;
            }
        }

        function updateCacheStats(stats) {
            const totalCacheSizeElement = document.getElementById('totalCacheSize');
            const cacheItemCountElement = document.getElementById('cacheItemCount');
            
            if (totalCacheSizeElement) {
                totalCacheSizeElement.textContent = stats.totalSize || '0 MB';
            }
            if (cacheItemCountElement) {
                cacheItemCountElement.textContent = stats.itemCount || 0;
            }
        }

        function updateAdBlockStats(stats) {
            const blockedDomainsCountElement = document.getElementById('blockedDomainsCount');
            const cssRulesCountElement = document.getElementById('cssRulesCount');
            const filterRulesCountElement = document.getElementById('filterRulesCount');
            
            if (blockedDomainsCountElement) {
                blockedDomainsCountElement.textContent = stats.blockedDomains || 0;
            }
            if (cssRulesCountElement) {
                cssRulesCountElement.textContent = stats.cssRules || 0;
            }
            if (filterRulesCountElement) {
                filterRulesCountElement.textContent = stats.filterRules || 0;
            }
        }

        // MCP Testing Functions
        async function testMcpIntegration() {
            const logElement = document.getElementById('mcp-test-log');
            const statusElement = document.getElementById('mcp-test-status');
            
            logElement.style.display = 'block';
            logElement.textContent = '';
            statusElement.innerHTML = '<div style="padding: 10px; background: #d1ecf1; color: #0c5460; border-radius: 4px;">üîÑ Running MCP integration test...</div>';
            
            function log(message) {
                const timestamp = new Date().toLocaleTimeString();
                logElement.textContent += `[${timestamp}] ${message}\n`;
                logElement.scrollTop = logElement.scrollHeight;
            }
            
            try {
                log('üöÄ Starting MCP Integration Test in Browzer Electron...');
                
                // Test 1: Environment Check
                log('\n1Ô∏è‚É£ Testing Electron Environment:');
                const envTests = [
                    { name: 'fetch API', test: () => typeof fetch !== 'undefined' },
                    { name: 'WebSocket API', test: () => typeof WebSocket !== 'undefined' },
                    { name: 'localStorage', test: () => typeof localStorage !== 'undefined' },
                    { name: 'EventSource', test: () => typeof EventSource !== 'undefined' },
                    { name: 'URL constructor', test: () => typeof URL !== 'undefined' }
                ];
                
                let envOk = true;
                envTests.forEach(({ name, test }) => {
                    const passed = test();
                    envOk = envOk && passed;
                    log(`   ${passed ? '‚úÖ' : '‚ùå'} ${name}: ${passed ? 'Available' : 'Missing'}`);
                });
                
                if (!envOk) {
                    throw new Error('Environment check failed - missing required APIs');
                }
                
                // Test 2: MCP Connection
                log('\n2Ô∏è‚É£ Testing MCP Server Connection:');
                const zapierUrl = 'https://mcp.zapier.com/api/mcp/s/ZjgwOGM1ZjctYjBkZC00ZWM4LWFiOGEtMGE2ZTA0NmJhNzgzOjdjNDEwOTc0LTIzNTctNGYyYy1hZTBiLWU4Mjg2OTA2MzZlZQ==/mcp';
                
                const initPayload = {
                    jsonrpc: '2.0',
                    id: 1,
                    method: 'initialize',
                    params: {
                        protocolVersion: '2024-11-05',
                        capabilities: { tools: {} },
                        clientInfo: { name: 'browzer-electron-test', version: '1.0.0' }
                    }
                };
                
                log('   üì§ Sending initialize request...');
                const response = await fetch(zapierUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json, text/event-stream'
                    },
                    body: JSON.stringify(initPayload)
                });
                
                log(`   üì• Response: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Handle SSE response
                let serverConnected = false;
                if (response.headers.get('content-type')?.includes('text/event-stream')) {
                    log('   üì° Processing SSE stream...');
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';

                        let currentEvent = {};
                        
                        for (const line of lines) {
                            if (line.startsWith('data:')) {
                                currentEvent.data = line.substring(5).trim();
                            } else if (line === '') {
                                if (currentEvent.data) {
                                    try {
                                        const eventData = JSON.parse(currentEvent.data);
                                        if (eventData.result && eventData.result.serverInfo) {
                                            const server = eventData.result.serverInfo;
                                            log(`   ‚úÖ Connected to: ${server.name} v${server.version}`);
                                            serverConnected = true;
                                            break;
                                        }
                                    } catch (parseError) {
                                        // Continue processing
                                    }
                                }
                                currentEvent = {};
                            }
                        }
                        
                        if (serverConnected) break;
                    }
                }
                
                if (!serverConnected) {
                    throw new Error('Failed to establish MCP connection');
                }
                
                // Test 3: Tools List
                log('\n3Ô∏è‚É£ Testing Tools Discovery:');
                const toolsPayload = {
                    jsonrpc: '2.0',
                    id: 2,
                    method: 'tools/list',
                    params: {}
                };
                
                const toolsResponse = await fetch(zapierUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json, text/event-stream'
                    },
                    body: JSON.stringify(toolsPayload)
                });
                
                let toolsFound = 0;
                if (toolsResponse.headers.get('content-type')?.includes('text/event-stream')) {
                    const reader = toolsResponse.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';

                        let currentEvent = {};
                        
                        for (const line of lines) {
                            if (line.startsWith('data:')) {
                                currentEvent.data = line.substring(5).trim();
                            } else if (line === '') {
                                if (currentEvent.data) {
                                    try {
                                        const eventData = JSON.parse(currentEvent.data);
                                        if (eventData.result && eventData.result.tools) {
                                            const tools = eventData.result.tools;
                                            toolsFound = tools.length;
                                            log(`   ‚úÖ Discovered ${tools.length} tools!`);
                                            
                                            // Show sample tools
                                            log('   üìã Sample tools:');
                                            tools.slice(0, 3).forEach((tool, i) => {
                                                log(`      ${i + 1}. ${tool.name} - ${tool.description?.substring(0, 60) || 'No description'}...`);
                                            });
                                            
                                            if (tools.length > 3) {
                                                log(`      ... and ${tools.length - 3} more tools`);
                                            }
                                            break;
                                        }
                                    } catch (parseError) {
                                        // Continue processing
                                    }
                                }
                                currentEvent = {};
                            }
                        }
                        
                        if (toolsFound > 0) break;
                    }
                }
                
                // Test 4: McpClientManager
                log('\n4Ô∏è‚É£ Testing McpClientManager Class:');
                try {
                    // Try to import and test the actual manager
                    log('   üîß Testing manager functionality...');
                    
                    // Test localStorage for MCP configs
                    const testConfig = {
                        name: 'zapier-electron-test',
                        url: zapierUrl,
                        enabled: false,
                        transport: 'sse'
                    };
                    
                    localStorage.setItem('mcp_test_electron', JSON.stringify([testConfig]));
                    const retrieved = JSON.parse(localStorage.getItem('mcp_test_electron'));
                    localStorage.removeItem('mcp_test_electron');
                    
                    if (retrieved && retrieved[0].name === 'zapier-electron-test') {
                        log('   ‚úÖ McpClientManager storage compatibility verified');
                    } else {
                        throw new Error('Storage test failed');
                    }
                    
                } catch (error) {
                    log(`   ‚ö†Ô∏è McpClientManager test: ${error.message}`);
                }
                
                // Summary
                log('\nüìä Test Results:');
                log(`   Environment: ‚úÖ Pass`);
                log(`   Connection: ‚úÖ Pass`);
                log(`   Tools Discovery: ${toolsFound > 0 ? '‚úÖ Pass' : '‚ùå Fail'} (${toolsFound} tools)`);
                log(`   Manager Compatibility: ‚úÖ Pass`);
                
                log('\nüéâ MCP Integration Test PASSED!');
                log('üí° MCP is fully functional in Browzer Electron');
                log('üí° You can now add MCP servers in the settings above');
                
                statusElement.innerHTML = '<div style="padding: 10px; background: #d4edda; color: #155724; border-radius: 4px;">‚úÖ All tests passed! MCP is working in Browzer.</div>';
                
            } catch (error) {
                log(`\n‚ùå Test failed: ${error.message}`);
                statusElement.innerHTML = `<div style="padding: 10px; background: #f8d7da; color: #721c24; border-radius: 4px;">‚ùå Test failed: ${error.message}</div>`;
            }
        }
        
        function clearMcpTestLog() {
            const logElement = document.getElementById('mcp-test-log');
            const statusElement = document.getElementById('mcp-test-status');
            
            logElement.textContent = '';
            logElement.style.display = 'none';
            statusElement.innerHTML = '';
        }

        // Debug function for troubleshooting MCP panel
        window.debugMcpPanel = function() {
            console.log('üêõ DEBUG MCP PANEL:');
            console.log('- Root element:', document.getElementById('mcp-servers-root'));
            console.log('- Add button:', document.querySelector('#mcp-add-btn'));
            console.log('- Current configs:', localStorage.getItem('mcp_servers'));
            console.log('- Re-initializing...');
            initializeMcpPanel();
        };

        // Global add server function (backup for onclick)
        window.mcpAddServer = function() {
            console.log('üöÄ Global mcpAddServer called!');
            showAddServerModal();
        };

        // Create and show add server modal
        function showAddServerModal() {
            // Remove existing modal if any
            const existingModal = document.getElementById('mcp-add-modal');
            if (existingModal) existingModal.remove();

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'mcp-add-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 8px;
                    width: 500px;
                    max-width: 90vw;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                ">
                    <h3 style="margin-top: 0; color: #333;">Add MCP Server</h3>
                    
                    <div style="margin: 15px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Server Name:</label>
                        <input type="text" id="mcp-name-input" placeholder="e.g., zapier" style="
                            width: 100%;
                            padding: 8px 12px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 14px;
                            box-sizing: border-box;
                        ">
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Server URL:</label>
                        <input type="text" id="mcp-url-input" placeholder="https://mcp.zapier.com/api/mcp/s/.../mcp" style="
                            width: 100%;
                            padding: 8px 12px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 14px;
                            box-sizing: border-box;
                        ">
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            For Zapier MCP, use your specific server URL from Zapier dashboard
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
                        <button id="mcp-modal-cancel" style="
                            padding: 8px 16px;
                            border: 1px solid #ddd;
                            background: white;
                            border-radius: 4px;
                            cursor: pointer;
                        ">Cancel</button>
                        <button id="mcp-modal-add" style="
                            padding: 8px 16px;
                            border: none;
                            background: #007bff;
                            color: white;
                            border-radius: 4px;
                            cursor: pointer;
                        ">Add Server</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Focus on name input
            const nameInput = document.getElementById('mcp-name-input');
            const urlInput = document.getElementById('mcp-url-input');
            nameInput.focus();

            // Handle cancel
            document.getElementById('mcp-modal-cancel').onclick = () => {
                modal.remove();
            };

            // Handle click outside modal
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };

            // Handle add server
            document.getElementById('mcp-modal-add').onclick = () => {
                const name = nameInput.value.trim();
                const url = urlInput.value.trim();

                if (!name) {
                    nameInput.style.borderColor = '#dc3545';
                    nameInput.focus();
                    return;
                }

                if (!url) {
                    urlInput.style.borderColor = '#dc3545';
                    urlInput.focus();
                    return;
                }

                try {
                    const cfg = { name, url, enabled: true };
                    const configs = JSON.parse(localStorage.getItem('mcp_servers') || '[]');
                    
                    // Check for duplicate names
                    if (configs.find(c => c.name === name)) {
                        nameInput.style.borderColor = '#dc3545';
                        nameInput.focus();
                        alert('Server name already exists!');
                        return;
                    }
                    
                    configs.push(cfg);
                    localStorage.setItem('mcp_servers', JSON.stringify(configs));
                    
                    console.log('‚úÖ Server added:', cfg);
                    modal.remove();
                    
                    // Show success message
                    const success = document.createElement('div');
                    success.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #28a745;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 4px;
                        z-index: 10001;
                        font-weight: 500;
                    `;
                    success.textContent = `‚úÖ Server "${name}" added successfully!`;
                    document.body.appendChild(success);
                    
                    setTimeout(() => success.remove(), 3000);
                    
                    // Try to refresh the panel
                    if (typeof initializeMcpPanel === 'function') {
                        initializeMcpPanel();
                    } else {
                        location.reload();
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error adding server:', error);
                    alert('Error adding server: ' + error.message);
                }
            };

            // Handle Enter key
            [nameInput, urlInput].forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('mcp-modal-add').click();
                    }
                });
            });
        }

        // Quick add server function for testing
        window.addTestServer = function() {
            const cfg = {
                name: 'zapier',
                url: 'https://mcp.zapier.com/api/mcp/s/ZjgwOGM1ZjctYjBkZC00ZWM4LWFiOGEtMGE2ZTA0NmJhNzgzOjdjNDEwOTc0LTIzNTctNGYyYy1hZTBiLWU4Mjg2OTA2MzZlZQ==/mcp',
                enabled: true
            };
            
            const configs = JSON.parse(localStorage.getItem('mcp_servers') || '[]');
            configs.push(cfg);
            localStorage.setItem('mcp_servers', JSON.stringify(configs));
            
            console.log('‚úÖ Test server added:', cfg);
            initializeMcpPanel();
        };
    </script>
</body>
</html> 